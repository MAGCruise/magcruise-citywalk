<!DOCTYPE html>
<html xmlns="http://www.w3.org/1999/xhtml"
	xmlns:th="http://www.thymeleaf.org" lang="ja">
<head>
<head>
<meta charset="UTF-8" />
<link
	href="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/css/bootstrap.min.css"
	rel="stylesheet">
<link
	href="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/themes/smoothness/jquery-ui.css"
	rel="stylesheet">
<script
	src="http://ajax.googleapis.com/ajax/libs/jquery/2.1.3/jquery.min.js"></script>
<script
	src="http://ajax.googleapis.com/ajax/libs/jqueryui/1.11.2/jquery-ui.min.js"></script>
<script
	src="http://maxcdn.bootstrapcdn.com/bootstrap/3.3.1/js/bootstrap.min.js"></script>
<script src="../js/jsonrpc.js"></script>
<script src="../js/parseUri.js"></script>
<script>
	var url = "http://localhost:8080/magcruise-citywalk-server/CityWalkService";
	function getEventsByWebsocket(wsUrl) {
		var connection = new WebSocket(wsUrl);
		connection.onmessage = function(e) {
			var messages = JSON.parse(e.data);
			for (var i = 0; i < messages.length; i++) {
				$('#notification').append(JSON.stringify(messages[i]));
			}
		};
		return {
			abort : function() {
				connection.close();
			}
		};
	}

	$(function() {
		$('#insert-activity')
				.on(
						'click',
						function() {
							var arg = {
								userId : "ayaki",
								taskId : "task2",
								score : 9.0,
								input : {
									instanceClass : "org.magcruise.citywalk.model.content.SelectionInput",
									value : "1"
								}
							};
							new JsonRpcClient(new JsonRpcRequest(url,
									"addActivity", [ arg ])).rpc();
						});
	});
	$(function() {
		$('#login').on(
				'click',
				function() {
					new JsonRpcClient(new JsonRpcRequest(url, "login", [
							"ayaki", "houchimin" ])).rpc();
				});
	});
	$(function() {
		var uri = new parseUri(location);
		var wsUrl = 'ws://' + uri.host + ":" + uri.port + "/"
				+ uri.path.split("/")[1] + "/websocket/newEvents/" + "ayaki";
		getEventsByWebsocket(wsUrl);
	});

	$(function() {
		function handleFileSelect(evt) {
			var files = evt.target.files; // FileList object

			// Loop through the FileList and render image files as thumbnails.
			for (var i = 0, f; f = files[i]; i++) {

				// Only process image files.
				if (!f.type.match('image.*')) {
					continue;
				}

				var reader = new FileReader();

				// Closure to capture the file information.
				reader.onload = (function(theFile) {
					return function(e) {
						// Render thumbnail.
						var span = document.createElement('span');
						span.innerHTML = [ '<img class="thumb" src="',
								e.target.result, '" title="',
								escape(theFile.name), '"/>' ].join('');
						document.getElementById('list')
								.insertBefore(span, null);
						new JsonRpcClient(new JsonRpcRequest(url,
								"uploadImage", [ e.target.result ])).rpc();
					};
				})(f);

				// Read in the image file as a data URL.
				reader.readAsDataURL(f);
			}
		}

		document.getElementById('files').addEventListener('change',
				handleFileSelect, false);
	});
</script>
</head>
<body>
	<div class="container">
		<div class="row">
			<div class="col-sm-12">
				<h1>JSON-RPC API呼び出しテスト</h1>
				<a href="../CityWalkService">JSON-RPC API呼び出しテストページ</a>
				<h1>JSON-RPCでInsert</h1>
				<div>
					<a id="insert-activity" class="btn btn-primary">insert activity</a>
					<a id="login" class="btn btn-primary">login</a>
				</div>
				<input type="file" id="files" name="files[]" multiple />
				<output id="list"></output>
				<div id="result"></div>
				<h1>Websocketで通知を取得</h1>
				<div id="notification" class="well"></div>
			</div>
		</div>
	</div>
</body>
</html>
